<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slide Backup Dashboard - TRMNL</title>
    
    <!-- TRMNL Framework CSS and JS -->
    <link rel="stylesheet" href="https://usetrmnl.com/css/latest/plugins.css">
    <script src="https://usetrmnl.com/js/latest/plugins.js"></script>
    
    <!-- Google Fonts for TRMNL -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;350;375;400;450;600;700&display=swap" rel="stylesheet">
    
    <!-- Highcharts for charts -->
    <script src="https://usetrmnl.com/js/highcharts/12.3.0/highcharts.js"></script>
    <script src="https://usetrmnl.com/js/highcharts/12.3.0/highcharts-more.js"></script>
    <script src="https://usetrmnl.com/js/highcharts/12.3.0/pattern-fill.js"></script>
    
    <style>
        .rounded--medium {
            border-radius: 10px;
        }
        
        .title_bar {
            margin-top: auto;
        }
        
        .alerts-container {
            margin: 15px 0;
        }
        
        .alerts-container .item + .item {
            margin-top: 10px;
        }
    </style>
</head>
<body class="environment trmnl">
    <div class="screen">
        <div class="view view--full">
            <div class="layout">
                <div class="columns">
                    <div class="column">
                        <!-- Header Stats -->
                        <div class="grid grid--cols-4 gap--medium mb--large">
                            <div class="stat-card rounded--medium">
                                <div class="content text--center">
                                    <span class="value value--large value--tnums">{{ data.successful_backups_24h }}</span>
                                    <span class="label">Successful (24h)</span>
                                </div>
                            </div>
                            <div class="stat-card rounded--medium">
                                <div class="content text--center">
                                    <span class="value value--large value--tnums">{{ data.failed_backups_24h }}</span>
                                    <span class="label">Failed (24h)</span>
                                </div>
                            </div>
                            <div class="stat-card rounded--medium">
                                <div class="content text--center">
                                    <span class="value value--large value--tnums">{{ data.success_rate }}%</span>
                                    <span class="label">Success Rate</span>
                                </div>
                            </div>
                            <div class="stat-card rounded--medium {% if data.active_alerts > 0 %}bg-black text--white{% endif %}">
                                <div class="content text--center">
                                    <span class="value value--large value--tnums">{{ data.active_alerts }}</span>
                                    <span class="label {% if data.active_alerts > 0 %}text--white{% endif %}">Active Alerts</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border--h-3"></div>
                        
                        <!-- System Overview -->
                        <div class="grid grid--cols-3 gap--medium">
                            <div class="item rounded--medium">
                                <div class="meta"></div>
                                <div class="content">
                                    <span class="value value--tnums">{{ data.total_agents }}</span>
                                    <span class="label">Total Agents</span>
                                    <div class="mt--5">
                                        <span class="description">
                                            Online: {{ data.agents_online }} | 
                                            Warning: {{ data.agents_warning }} | 
                                            Offline: {{ data.agents_offline }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="item rounded--medium">
                                <div class="meta"></div>
                                <div class="content">
                                    <span class="value value--tnums">{{ data.total_devices }}</span>
                                    <span class="label">Total Devices</span>
                                    <div class="mt--5">
                                        <span class="description">{{ data.total_snapshots }} snapshots stored</span>
                                    </div>
                                </div>
                            </div>
                            <div class="item rounded--medium">
                                <div class="meta"></div>
                                <div class="content">
                                    <span class="value value--tnums">{{ data.storage_used_formatted }}</span>
                                    <span class="label">Storage Used</span>
                                    <div class="mt--5">
                                        <span class="description">
                                            {{ data.storage_used_percent }}% of {{ data.storage_total_formatted }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 24-Hour Backup Activity Chart OR Alert Display -->
                        <div class="mt--large">
                            <div class="border--h-3"></div>
                            {% if data.has_alerts and data.recent_alerts.size > 0 %}
                                <!-- Show recent alerts when there are active alerts -->
                                <h3 class="title title--small mt--4 mb--small">Current Alerts</h3>
                                <div class="alerts-container">
                                    {% for alert in data.recent_alerts %}
                                        <div class="item {% if forloop.index == 1 %}item--emphasis-3{% else %}item--emphasis-2{% endif %}">
                                            <div class="meta"></div>
                                            <div class="content">
                                                <span class="title title--small">{{ alert.title }}</span>
                                                <span class="description">{{ alert.message }}</span>
                                                <div class="flex gap--small mt--small">
                                                    {% if alert.device_name != blank and alert.device_name != 'Unknown Device' %}
                                                        <span class="label label--small label--underline">Device: {{ alert.device_name }}</span>
                                                    {% endif %}
                                                    {% if alert.agent_hostname != blank %}
                                                        <span class="label label--small label--underline">Agent: {{ alert.agent_hostname }}</span>
                                                    {% endif %}
                                                    <span class="label label--small label--underline">{{ alert.time_ago }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <!-- Show chart when no active alerts -->
                                <h3 class="title title--small mt--4 mb--small">24-Hour Backup Activity</h3>
                                <div id="hourly-chart" style="width: 100%;"></div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="title_bar">
                <span class="title">Slide Backups</span>
                <span class="instance">{{ data.client_name }}</span>
                <span class="instance">{{ data.current_time }} {{ data.timezone }}</span>
            </div>
        </div>
    </div>
    
    {% if data.show_chart %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Prepare hourly data for 24-hour chart
            var hourlyData = {{ data.hourly_backups | json }};
            var hourlyChartData = [];
            
            // Process the data
            if (hourlyData && hourlyData.length > 0) {
                hourlyData.forEach(function(item) {
                    // Parse the date string properly
                    var dateParts = item.hour.split(' ');
                    var dateStr = dateParts[0] + 'T' + dateParts[1] + ':00';
                    var timestamp = new Date(dateStr).getTime();
                    hourlyChartData.push([timestamp, parseInt(item.count) || 0]);
                });
            }
            
            // Sort by timestamp
            hourlyChartData.sort(function(a, b) { return a[0] - b[0]; });
            
            // Create 24-hour activity chart using TRMNL framework formatting
            Highcharts.chart('hourly-chart', {
                chart: {
                    type: 'spline',
                    animation: false,
                    backgroundColor: 'transparent',
                    height: 160,
                    spacing: [10, 10, 5, 10]
                },
                title: { text: null },
                plotOptions: {
                    series: {
                        animation: false,
                        lineWidth: 4,
                        marker: {
                            enabled: false
                        },
                        color: 'black',
                        states: {
                            hover: {
                                enabled: false
                            }
                        },
                        enableMouseTracking: false
                    }
                },
                yAxis: {
                    title: { text: null },
                    labels: { 
                        style: { 
                            fontSize: '16px',
                            color: '#000000'
                        }
                    },
                    gridLineDashStyle: 'shortdot',
                    gridLineWidth: 1,
                    gridLineColor: '#000000',
                    tickAmount: 5,
                    min: 0
                },
                xAxis: {
                    type: 'datetime',
                    labels: {
                        format: '{value:%H}h',
                        style: { 
                            fontSize: '16px',
                            color: '#000000'
                        },
                        step: 3
                    },
                    lineWidth: 0,
                    gridLineDashStyle: 'dot',
                    tickWidth: 1,
                    tickLength: 0,
                    gridLineWidth: 1,
                    gridLineColor: '#000000',
                    tickPixelInterval: 120
                },
                series: [{
                    name: 'Successful Backups',
                    data: hourlyChartData,
                    color: 'black'
                }],
                legend: { enabled: false },
                credits: { enabled: false },
                tooltip: { enabled: false }
            });
        });
    </script>
    {% endif %}
</body>
</html>
